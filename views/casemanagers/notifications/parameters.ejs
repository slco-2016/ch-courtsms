<% include ../../partials/headers/header-base %>

<!-- Include Card View specific styling -->
<link rel="stylesheet" type="text/css" href="/static/css/card.css">
<link rel="stylesheet" type="text/css" href="/static/css/cardInverse.css">

<div class="contents">

<!-- Moved the exit out of the card -->
<a href="/cms/<%= user.cmid %>/notifications">
  <% include ../../partials/card-exit %>
</a>

<div class="card">

  <div class="card-title">
    Start Notification
  </div>

  <div class="comms-link">
    <small>
    <a href="/cms/<%= user.cmid %>/notifications/new/craftmessage">
      View All Notification
      <i class="fa fa-list-alt"></i>
    </a>
    </small>
  </div>

  <form method="post" id="newNotification" 
        <% if (typeof editView == "undefined") { %> 
          action="/cms/<%= user.cmid %>/notifications/new/craftmessage"
        <% } %> >

    <input type="hidden" name="cmid" value="<%= user.cmid %>">
    <input type="hidden" name="notiSubj" value="<%= notification.notiSubj %>">
    <input type="hidden" name="notiCopy" value="<%= notification.notiCopy %>">


    <div class="form-row">
      <div class="form-label"> Date to send <small>(YYYY-MM-DD)</small></div>
      <input class="form-input" type="date" name="sendDate" value="<%= notification.sendDate %>" required>
    </div>

    <div class="form-row">
      <div class="form-label"> Time to send </div>

      <!-- Options are for military hrs of day -->
      <select class="blue-select" name="sendTimeHour" required>
        <option value="00" 
          <% if (notification.sendTimeHour == 00) { %> selected <% } %> > 
            12:00 AM (Midnight)
        </option>
        <option value="01" 
          <% if (notification.sendTimeHour == 01) { %> selected <% } %> > 
            01:00 AM
        </option>
        <option value="02" 
          <% if (notification.sendTimeHour == 02) { %> selected <% } %> > 
            02:00 AM
        </option>
        <option value="03" 
          <% if (notification.sendTimeHour == 03) { %> selected <% } %> > 
            03:00 AM
        </option>
        <option value="04" 
          <% if (notification.sendTimeHour == 04) { %> selected <% } %> > 
            04:00 AM
        </option>
        <option value="05" 
          <% if (notification.sendTimeHour == 05) { %> selected <% } %> > 
            05:00 AM
        </option>
        <option value="06" 
          <% if (notification.sendTimeHour == 06) { %> selected <% } %> > 
            06:00 AM
        </option>
        <option value="07" 
          <% if (notification.sendTimeHour == 07) { %> selected <% } %> > 
            07:00 AM
        </option>
        <option value="08" 
          <% if (notification.sendTimeHour == 08) { %> selected <% } %> > 
            08:00 AM
        </option>
        <option value="09" 
          <% if (notification.sendTimeHour == 09) { %> selected <% } %> > 
            09:00 AM
        </option>
        <option value="10" 
          <% if (notification.sendTimeHour == 10) { %> selected <% } %> > 
            10:00 AM
        </option>
        <option value="11" 
          <% if (notification.sendTimeHour == 11) { %> selected <% } %> > 
            11:00 AM
        </option>
        <option value="12" 
          <% if (notification.sendTimeHour == 12) { %> selected <% } %> > 
            12:00 PM (Noon)
        </option>
        <option value="13" 
          <% if (notification.sendTimeHour == 13) { %> selected <% } %> > 
            01:00 PM
        </option>
        <option value="14" 
          <% if (notification.sendTimeHour == 14) { %> selected <% } %> > 
            02:00 PM
        </option>
        <option value="15" 
          <% if (notification.sendTimeHour == 15) { %> selected <% } %> > 
            03:00 PM 
        </option>
        <option value="16" 
          <% if (notification.sendTimeHour == 16) { %> selected <% } %> > 
            04:00 PM 
        </option>
        <option value="17" 
          <% if (notification.sendTimeHour == 17) { %> selected <% } %> > 
            05:00 PM 
        </option>
        <option value="18" 
          <% if (notification.sendTimeHour == 18) { %> selected <% } %> > 
            06:00 PM 
        </option>
        <option value="19" 
          <% if (notification.sendTimeHour == 19) { %> selected <% } %> > 
            07:00 PM 
        </option>
        <option value="20" 
          <% if (notification.sendTimeHour == 20) { %> selected <% } %> > 
            08:00 PM 
        </option>
        <option value="21" 
          <% if (notification.sendTimeHour == 21) { %> selected <% } %> > 
            09:00 PM 
        </option>
        <option value="22" 
          <% if (notification.sendTimeHour == 22) { %> selected <% } %> > 
            10:00 PM 
        </option>
        <option value="23" 
          <% if (notification.sendTimeHour == 23) { %> selected <% } %> > 
            11:00 PM 
        </option>
      </select>

      <input type="hidden" name="sendTimeMin" value="00">
      </select>

    </div>

    <div class="form-row">
      <div class="form-label"> Which client to notify  </div>
      <select class="blue-select" id="clientSelect" name="recipient" required>
        <option value="" disabled selected> Client </option>
        <% clients.forEach(function (client) { %>
          <option value="<%= client.id %>"
            <% if (notification.recipient == client.id) { %> selected <% } %> > 
              <%= client.name %> 
          </option>
        <% }); %>
      </select>
    </div>

    <div class="form-row">
      <div class="form-label"> Which device to send to </div>
      <select class="blue-select" id="commOptionsForClient" name="recipientComm" required>
        <option value="" disabled selected> Contact Info </option>
      </select>
    </div>

    <% if (typeof editView == "undefined") { %> 
      <input  type="button" 
              class="form-submit" 
              id="useTemplate"
              value="Use a Template">

      <div class="or-break" style="text-align: center">
        <span class="dash">-</span> or <span class="dash">-</span>
      </div>
    <% } %>

    <input  type="submit" 
            class="form-submit" 
            style="margin-top: 0px" 
            value="Next">

  </form>

</div>
</div>

<script type="text/javascript">
  // Set global variable of all clients information
  window.clients = <%- JSON.stringify(clients) %>;

  // Bind clients to update of comm list
  $("#clientSelect").change(function () {
    // Get new client id value
    var v = $(this)[0].value;
    updateClientsAndComms(v)
  });

  function updateClientsAndComms (v, id) {
    // Remove all existing children in options
    $("#commOptionsForClient").empty();

    // Now add all client comms associated with that client
    clients.forEach(function (client) {
      // Only add if client matches
      if (client.id == v) {
        client.comms.forEach(function (comm) {
          var newOpt =  '<option value="' + comm.id + '" ';

          // Make selected if it was selected from before
          if (id && id == comm.id) {
            newOpt +=  ' selected ';
          }

          // Append the end content
          newOpt +=     '">' +
                        comm.name + " (" + comm.value + ")" +
                        '</option>';

          $("#commOptionsForClient").append(newOpt);
        });
      }
    });
  };

  // Special card toggle option
  $("#useTemplate").click(function () {
    tellKeenIOTemplateOptionSelected();
    goToCard(2);
  });

  $("#notificationCopyView").click(function () {
    goToCard(3);
  });

  function goToCard (number) {
    number = String(number);
    var input = $("<input>", { type: "hidden", name: "showCardExplicit", value: number }); 
    $("#newNotification").append($(input));

    if (number == 2) {
      $("#newNotification").attr("action", "/cms/<%= user.cmid %>/notifications/new/selecttemplate");
    }

    $("#newNotification").submit(); 
  };

  function tellKeenIOTemplateOptionSelected () {
    try {
      var toggleSwitchClickEvent = {
        user: {
          first:  "<%= user.first %>",
          last:   "<%= user.last %>",
          email:  "<%= user.email %>",
          cmid:   "<%= user.cmid %>"
        },
        keen: {
          timestamp: new Date().toISOString()
        }
      };

      createKeenClient()
      .addEvent("load_template_in_notifications", toggleSwitchClickEvent, function (err, res) {
        if (err) {
          console.log(err);
        }
      });
    } catch (e) {
      console.log(e);
    }
  }

  // Run once on load to populate defaults
  <% if (notification.recipient && notification.recipientComm) { %>
    updateClientsAndComms(<%= notification.recipient %>, <%= notification.recipientComm %>);
  <% } %>

</script>

<% include ../../partials/footers/footer %>
