<% include ../partials/cardFrameTop %>

<div class="cardHead">
  <a href="<%=`${level === "org" ? "/org/clients" : "/clients"}`%>"><% include ../partials/cardExit %></a>
  <div class="cardTitle">Transfer Client</div>
  <div class="cardSubtitle">
    Transfer a client to a another case manager.
    <% if (allDepartments) { %>
      Showing case managers from all departments.
    <% } %>
  </div>
</div>

<div class="cardBody">

  <div class="formRow">
    <% if (user.class !== "owner") { %>
      <% if (allDepartments) { %>
        <a href="<%=`/clients/${client.clid}/transfer?allDepartments=false`%>">
          <input type="submit" id="useTemplate" class="formSubmit inverse" value="Transfer within your department">
        </a>
      <% } else { %>
        <a href="<%=`/clients/${client.clid}/transfer?allDepartments=true`%>">
          <input type="submit" id="useTemplate" class="formSubmit inverse" value="Transfer outside of this department">
        </a>
      <% } %>
    <% } %>
  </div>

  <form method = "post"
        id="userSearch">

    <div class="formRow">
      <div class="formLabel">
        Search for a Case Manager
      </div>
      <div class="formInput">
        <input class="typeahead" type="text" placeholder="Case manager name">
      </div>
    </div>

    <div class="formRow">
      <div class="formLabel">
        Select whether to transfer all current conversations
      </div>
      <div class="formInput">
        <input type="checkbox" name="bundleConversations" value="true" checked> Bundle current manager's conversations in transfer
      </div>
    </div>

    <input type="hidden" id="targetUser" name="user">
    <input type="submit" class="formSubmit" value="Submit">

  </form>
</div>



<script src="/components/typeahead.js/dist/typeahead.jquery.min.js"></script>

<script type="text/javascript">

  // global
  var users = <%- JSON.stringify(users); %>;

  var substringMatcher = function (strs) {
    return function findMatches(q, cb) {
      var matches = [];
      var substrRegex = new RegExp(q, 'i');
      $.each(strs, function(i, str) {
        var name = str.first + " " + str.last;
        if (substrRegex.test(name)) matches.push(name);
      });

      cb(matches);
    };
  };

  $(".formInput .typeahead")
  .typeahead({
      hint: true,
      highlight: true,
      minLength: 1
    },
    {
      name: "users",
      value: "cmid",
      source: substringMatcher(users),
      select: function (e, i) { console.log( e, i )}
  });

  $("#userSearch").submit(function (event) {
    var selectedName = $(".tt-input").val();
    var selectedUser = null;
    users.forEach(function (u) {
      var name = u.first + " " + u.last;
      if (name == selectedName) selectedUser = u;
    });
    if (selectedUser) {
      $("#targetUser").val(selectedUser.cmid)
      return true;
    } else {
      event.preventDefault();
      return false;
    }
  })

</script>

<% include ../partials/cardFrameBottom %>