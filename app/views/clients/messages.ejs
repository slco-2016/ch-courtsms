<% let clientBaseURL = `${level === "org" ? "/org" : ""}/clients/${client.clid}`; %>

<% include ../partials/clientFrameTop %>

<!-- Load in addition CSS -->
<link rel="stylesheet" type="text/css" href="/static/css/v4_clientMessages.css">

<div class="leftBar">
  <div class="conversations">
    <div class="conversation">
      <div class="subject showAll">
        <a href="<%=`/clients/${client.clid}/messages`%>">Show all conversations</a>
      </div>
    </div>
    <% conversations.forEach(function (conversation) { %>
      <a href="<%=`/clients/${client.clid}/messages?conversation=${conversation.convid}`%>">
        <div class="conversation <% if (convoFilter == Number(conversation.convid)) { %>selected<% } %>">
          <div class="subject">
            <%= conversation.subject ? conversation.subject : 'No Subject' %>
          </div>
          <div class="date">
            <div class="day"><%= moment.tz(conversation.updated, organization.tz).format("MM/DD/YY") %></div>
            <div class="time"><%= moment.tz(conversation.updated, organization.tz).format("hh:mm A") %></div>
          </div>
        </div>
      </a>
    <% }) %>
  </div>
</div>


<div class="rightContent">

  <div class="messageStream">
    <% messages.forEach(function (message, messageIndex) { %>
      <div class="message <%= message.inbound ? 'inbound' : 'outbound' %>"
            <% if (messageIndex == messages.length - 1) { %>id="lastMessage"<% } %>>
        <div class="content">
          <%= message.content %>
        </div>

        <div class="bottomRow">

          <% if (message.comm_type == 'cell') { %>
            <i class="fa fa-mobile" aria-hidden="true"></i>
          <% } %>

          <%= message.inbound ? 'Received via' : 'Sent to' %>
          <%= client.first + "'s" %> <%= message.commconn_name %>

          <span class="state">
            <%= message.tw_status %> on 
            <%= moment.tz(message.created, organization.tz).format("MM/DD"); %> at 
            <%= moment.tz(message.created, organization.tz).format("hh:mm A"); %>
          </span>
        </div>
      </div>
    <% }) %>
  </div>

  <div class="responseBox">
    <form method="post"
          id="newMessage" 
          action="<%=`/clients/${client.clid}/messages`%>">
      <% if (userOwnsClient) { %>
        <div class="mini" id="typeBox">
          <div class="messageInput">
            <div class="left">Start typing message...</div>
            <a href="<%=`${clientBaseURL}/address/templates`%>">
              <span class="miniButton">
                <i class="fa fa-send"></i> 
                Load a template
              </span>
            </a>
          </div>
        </div>
      <% } else { %>
        <div class="mini">
          <div class="messageInput disabled">
            Viewing other user's client conversation log, cannot comment directly in thread.
            <a href="<%=`/org/clients/${client.clid}/address`%>">
              <span class="miniButton">
                <i class="fa fa-send"></i> 
                Send a one-off message
              </span>
            </a>
          </div>
        </div>
      <% } %>

      <div class="full">
        <div class="messageInput">
          <textarea name="content"
                    rows="5"></textarea>
        </div>

        <div class="bottomRow">

          <a href="<%=`${clientBaseURL}/address/templates`%>">
            <div class="optionButton">
              <i class="fa fa-upload" aria-hidden="true"></i> 
              Load a Template
            </div>
          </a>

          <div class="contactSelect">
            <select name="commID" required>
              <option value="" selected disabled>Comm Method</option>
              <% communications.forEach(function (communication) { %>
                <option value="<%= communication.commid %>"><%= communication.name + ' (' + communication.value + ')' %></option>
              <% }) %>
            </select>
          </div>

          <div class="submit disabled">
            <i class="fa fa-paper-plane" aria-hidden="true"></i>
            Send
          </div>
        </div>
      </div>
    </form>
  </div>

</div>

<script type="text/javascript" class="JSmessagesStream"></script>

<% include ../partials/hubFrameBottom %>